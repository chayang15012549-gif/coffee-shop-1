<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Checkout - Deluxe Cafe</title>
    <!-- Bootstrap + FontAwesome (lightweight CDNs) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Color palette: coffee / cream / dark-green */
        :root{ --primary:#5C3D2E; --secondary:#A0522D; --accent:#6B8E23; --cream:#FDF8F3; }
        body{ font-family: Poppins, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:var(--cream); color:#3d3d3d; }
        .checkout-card{ border-radius:16px; box-shadow:0 8px 30px rgba(92,61,46,0.12); overflow:hidden }
        .payment-option{ cursor:pointer; border-radius:12px; padding:12px; transition:all .18s ease; border:1px solid transparent }
        .payment-option:hover{ transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,0.06) }
        .payment-option.active{ border-color:rgba(92,61,46,0.15); background:linear-gradient(90deg, rgba(245,238,233,0.6), rgba(255,255,255,0.4)) }
        .payment-icon{ width:44px; height:44px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.04); color:var(--primary); font-size:18px }
        .method-panel{ display:none; padding:12px 0 }
        .method-panel.active{ display:block }
        .btn-confirm{ background:linear-gradient(135deg,var(--secondary),var(--primary)); color:white; font-weight:700; border-radius:12px; padding:12px 20px; box-shadow:0 8px 25px rgba(92,61,46,0.18); }
        .form-control:focus{ box-shadow:0 0 0 0.15rem rgba(107,142,35,0.12); border-color:var(--accent) }
        .qr-box{ width:180px; height:180px; display:flex; align-items:center; justify-content:center; background:white; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06) }
        @media (max-width:767px){ .qr-box{ width:140px;height:140px } }
        .small-muted{ color:#666; font-size:0.9rem }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="checkout-card bg-white p-4">
                    <h3 class="mb-2" style="color:var(--primary)">ช่องทางชำระเงิน</h3>
                    <p class="small-muted">เลือกช่องทางที่ต้องการ แล้วกรอกข้อมูลที่เกี่ยวข้อง เพื่อยืนยันการชำระเงิน</p>

                    <!-- Order Summary (simple) -->
                    <div class="d-flex justify-content-between align-items-center mt-3 mb-4 p-3 rounded-3" style="background:#fbf8f5;border:1px solid rgba(92,61,46,0.03)">
                        <div>
                            <div class="fw-bold">ยอดรวม</div>
                            <div class="small-muted">รวมสินค้าทั้งหมด</div>
                        </div>
                        <div class="h4 mb-0" id="order-amount">฿<span>{{ total if total is not none else '0.00' }}</span></div>
                    </div>

                    <!-- Payment Options -->
                    <form id="checkout-form" method="POST" action="/checkout" novalidate>
                        <input type="hidden" name="amount" id="input-amount" value="{{ total if total is not none else '' }}">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2">
                                    <!-- Bank transfer -->
                                    <label class="payment-option d-flex align-items-center gap-3" data-method="bank">
                                        <div class="payment-icon"><i class="fas fa-university"></i></div>
                                        <div>
                                            <div class="fw-bold">โอนผ่านธนาคาร</div>
                                            <div class="small-muted">สลิปหรือรหัสการโอน</div>
                                        </div>
                                        <input type="radio" name="payment_method" value="bank" class="d-none">
                                    </label>

                                    <!-- Card -->
                                    <label class="payment-option d-flex align-items-center gap-3" data-method="card">
                                        <div class="payment-icon"><i class="fas fa-credit-card"></i></div>
                                        <div>
                                            <div class="fw-bold">บัตรเครดิต / เดบิต</div>
                                            <div class="small-muted">ปลอดภัยด้วยการเข้ารหัส</div>
                                        </div>
                                        <input type="radio" name="payment_method" value="card" class="d-none">
                                    </label>

                                    <!-- PromptPay QR -->
                                    <label class="payment-option d-flex align-items-center gap-3" data-method="promptpay">
                                        <div class="payment-icon"><i class="fas fa-qrcode"></i></div>
                                        <div>
                                            <div class="fw-bold">พร้อมเพย์ (QR)</div>
                                            <div class="small-muted">สแกน QR เพื่อชำระทันที</div>
                                        </div>
                                        <input type="radio" name="payment_method" value="promptpay" class="d-none">
                                    </label>

                                    <!-- COD -->
                                    <label class="payment-option d-flex align-items-center gap-3" data-method="cod">
                                        <div class="payment-icon"><i class="fas fa-truck"></i></div>
                                        <div>
                                            <div class="fw-bold">เก็บเงินปลายทาง (COD)</div>
                                            <div class="small-muted">ชำระเมื่อรับสินค้า</div>
                                        </div>
                                        <input type="radio" name="payment_method" value="cod" class="d-none">
                                    </label>
                                </div>
                            </div>

                            <!-- Panels for each method -->
                            <div class="col-12">
                                <!-- Bank transfer panel -->
                                <div id="panel-bank" class="method-panel">
                                    <div class="mb-2 small-muted">เลือกธนาคารและกรอกรายละเอียดการโอน</div>
                                    <div class="row g-2">
                                        <div class="col-12 col-md-6">
                                            <label class="form-label">ธนาคาร</label>
                                            <select name="bank_name" class="form-select">
                                                <option value="">-- เลือกธนาคาร --</option>
                                                <option>KBANK</option>
                                                <option>SCB</option>
                                                <option>BBL</option>
                                            </select>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <label class="form-label">เลขที่บัญชี (สำหรับสลิป)</label>
                                            <input type="text" name="bank_account" class="form-control" placeholder="ระบุเลขที่บัญชี หรือรหัสอ้างอิง">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">อัปโหลดสลิป (เพิ่มเติม)</label>
                                            <input type="file" name="slip" class="form-control">
                                            <div class="small-muted mt-1">(ไม่บังคับ) หากมีสลิปโปรดอัปโหลด</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card panel -->
                                <div id="panel-card" class="method-panel">
                                    <div class="mb-2 small-muted">กรอกข้อมูลบัตรของคุณ</div>
                                    <div class="row g-2">
                                        <div class="col-12">
                                            <label class="form-label">ชื่อบนบัตร</label>
                                            <input type="text" name="card_name" class="form-control" placeholder="Name on card">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">หมายเลขบัตร</label>
                                            <input type="text" name="card_number" id="card-number" class="form-control" inputmode="numeric" placeholder="xxxx xxxx xxxx xxxx" maxlength="19">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">หมดอายุ (MM/YY)</label>
                                            <input type="text" name="card_expiry" class="form-control" placeholder="MM/YY" maxlength="5">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">CVV</label>
                                            <input type="password" name="card_cvv" class="form-control" inputmode="numeric" maxlength="4" placeholder="3-4 digits">
                                        </div>
                                    </div>
                                </div>

                                <!-- PromptPay panel -->
                                <div id="panel-promptpay" class="method-panel">
                                    <div class="d-flex gap-3 align-items-center">
                                        <div class="qr-box" id="promptpay-qr">
                                            <!-- QR will be an image from free QR generator with encoded reference -->
                                            <img id="promptpay-qr-img" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=PromptPay%3A%20deluxecafe" alt="PromptPay QR">
                                        </div>
                                        <div>
                                            <div class="fw-bold">พร้อมเพย์: 080-XXX-XXXX</div>
                                            <div class="small-muted">สแกน QR และกรอกยอดชำระ หรือคัดลอกหมายเลข</div>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="copy-promptpay">คัดลอกรหัส</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3 small-muted">หมายเหตุ: ระบบนี้แสดง QR เป็นตัวอย่าง เทียบเท่าการใช้งานจริง ต้องมีเซิร์ฟเวอร์/บัญชีพร้อมเพย์ของร้าน</div>
                                </div>

                                <!-- COD panel -->
                                <div id="panel-cod" class="method-panel">
                                    <div class="mb-2 small-muted">คุณเลือกเก็บเงินปลายทาง ผู้จัดส่งจะเรียกเก็บเงินเมื่อมอบสินค้า</div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="cod_confirm" id="cod-confirm">
                                        <label class="form-check-label" for="cod-confirm">ยอมรับเงื่อนไข COD และค่าธรรมเนียมเพิ่มเติม (ถ้ามี)</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Error / Success messages -->
                            <div class="col-12">
                                {% if errors %}
                                    <div class="alert alert-danger">
                                        <ul class="mb-0">
                                            {% for err in errors %}<li>{{ err }}</li>{% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-12 d-grid">
                                <!-- Confirm button is prominent -->
                                <button type="submit" class="btn-confirm" id="confirm-btn">ยืนยันการชำระเงิน</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JavaScript: Toggle payment panels, simple validation, card input formatting
        (function(){
            const options = document.querySelectorAll('.payment-option');
            const panels = {
                bank: document.getElementById('panel-bank'),
                card: document.getElementById('panel-card'),
                promptpay: document.getElementById('panel-promptpay'),
                cod: document.getElementById('panel-cod')
            };
            let selected = null;

            function clearActive(){ options.forEach(o=>o.classList.remove('active')); Object.values(panels).forEach(p=>p.classList.remove('active')) }

            options.forEach(opt=>{
                opt.addEventListener('click', ()=>{
                    clearActive();
                    opt.classList.add('active');
                    const method = opt.dataset.method;
                    selected = method;
                    // check the radio input inside and set checked
                    opt.querySelector('input[type=radio]').checked = true;
                    if(panels[method]) panels[method].classList.add('active');
                });
            });

            // copy promptpay reference
            document.getElementById('copy-promptpay').addEventListener('click', function(){
                const text = '080XXX1234';
                navigator.clipboard?.writeText(text).then(()=>{
                    alert('คัดลอกเรียบร้อย: '+text);
                }).catch(()=>{ alert('ไม่สามารถคัดลอกได้'); });
            });

            // format card number (xxxx xxxx xxxx xxxx)
            const cardNumberInput = document.getElementById('card-number');
            if(cardNumberInput){
                cardNumberInput.addEventListener('input', (e)=>{
                    let v = e.target.value.replace(/\D/g,'').slice(0,19);
                    v = v.match(/.{1,4}/g)?.join(' ') || v;
                    e.target.value = v;
                });
            }

            // Form submit: client-side validation for required fields per method
            document.getElementById('checkout-form').addEventListener('submit', function(e){
                const form = e.target;
                const method = form.payment_method.value;
                const errors = [];
                if(!method) errors.push('กรุณาเลือกช่องทางการชำระเงิน');
                if(method === 'card'){
                    const num = form.card_number?.value?.replace(/\s/g,'') || '';
                    const name = (form.card_name?.value||'').trim();
                    const exp = (form.card_expiry?.value||'').trim();
                    const cvv = (form.card_cvv?.value||'').trim();
                    if(!name) errors.push('กรุณากรอกชื่อบนบัตร');
                    if(num.length < 13 || !/^[0-9]+$/.test(num)) errors.push('หมายเลขบัตรไม่ถูกต้อง');
                    if(!/^(0[1-9]|1[0-2])\/\d{2}$/.test(exp)) errors.push('วันหมดอายุไม่ถูกต้อง (MM/YY)');
                    if(!/^[0-9]{3,4}$/.test(cvv)) errors.push('รหัส CVV ไม่ถูกต้อง');
                }
                if(method === 'cod'){
                    if(!form.cod_confirm?.checked) errors.push('กรุณายืนยันการยอมรับเงื่อนไข COD');
                }

                if(errors.length){
                    e.preventDefault();
                    alert(errors.join('\n'));
                    return false;
                }

                // Let form submit to server for further processing
            });
        })();
    </script>
</body>
</html>
